<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>量子销售经理智能体 - 真实API演示</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-container {
            height: calc(100vh - 120px);
        }
        .message-stream {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-indicator {
            display: inline-block;
            animation: blink 1.5s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .message-bubble {
            max-width: 70%;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        .user-message {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white
            margin-left: auto;
            border-bottom-right-radius: 6px;
        }
        .ai-message {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            color: #1f2937;
            border-bottom-left-radius: 6px;
            border: 1px solid #e5e7eb;
        }
        .ai-message:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }
        .message-content {
            padding: 14px 18px;
            word-wrap: break-word;
            line-height: 1.5;
        }
        .ai-message .message-content {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 15px;
        }
        .user-message .message-content {
            font-weight: 500;
        }
        .ai-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981, #059669);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            margin-right: 12px;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            margin-left: 12px;
        }
        .config-modal {
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="flex h-screen">
        <!-- 左侧边栏 -->
        <div class="w-80 bg-gray-800 border-r border-gray-700 flex flex-col">
            <!-- 角色卡区域 -->
            <div class="p-4 border-b border-gray-700">
                <h2 class="text-lg font-semibold mb-3">角色选择</h2>
                <div class="space-y-2">
                    <div class="agent-card bg-gray-700 rounded-lg p-3 cursor-pointer hover:bg-gray-600 transition-colors active-agent">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center">
                                <i class="fas fa-robot text-white"></i>
                            </div>
                            <div>
                                <h3 class="font-medium">量子加密文件销售助手</h3>
                                <p class="text-sm text-gray-300">企业级加密安全解决方案</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 工具选择区域 -->
            <div class="p-4 border-b border-gray-700">
                <h2 class="text-lg font-semibold mb-3">可用工具</h2>
                <div class="space-y-2">
                    <div class="tool-item bg-gray-700 rounded-lg p-3 cursor-not-allowed opacity-50">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-search text-blue-400"></i>
                            <span>知识库查询</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">暂未启用</p>
                    </div>
                    <div class="tool-item bg-gray-700 rounded-lg p-3 cursor-not-allowed opacity-50">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-file-alt text-green-400"></i>
                            <span>文档分析</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">暂未启用</p>
                    </div>
                </div>
            </div>

            <!-- 底部用户区域 -->
            <div class="mt-auto p-4">
                <div class="flex items-center space-x-3">
                    <div class="relative group">
                        <div class="w-10 h-10 rounded-full bg-purple-500 flex items-center justify-center cursor-pointer" id="userAvatar">
                            <i class="fas fa-user text-white"></i>
                        </div>
                        <!-- 配置菜单 -->
                        <div class="absolute bottom-full left-0 mb-2 w-48 bg-gray-700 rounded-lg shadow-lg hidden group-hover:block z-10" id="configMenu">
                            <div class="p-2">
                                <button class="w-full text-left px-3 py-2 rounded hover:bg-gray-600 transition-colors" onclick="exportConversation()">
                                    <i class="fas fa-download mr-2"></i>导出对话记录
                                </button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <p class="font-medium">访客用户</p>
                        <p class="text-sm text-gray-400">演示模式</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主聊天区域 -->
        <div class="flex-1 flex flex-col">
            <!-- 顶部状态栏 -->
            <div class="bg-gray-800 border-b border-gray-700 p-4">
                <div class="flex justify-between items-center">
                    <h1 class="text-xl font-bold">量子加密文件销售助手</h1>
                    <div class="flex items-center space-x-4">
                        <div class="status-indicator flex items-center space-x-2">
                            <div class="w-2 h-2 rounded-full bg-green-500"></div>
                            <span class="text-sm">在线</span>
                        </div>
                        <button class="px-3 py-1 bg-blue-600 rounded text-sm hover:bg-blue-700 transition-colors" onclick="startDemo()">
                            开始演示
                        </button>
                    </div>
                </div>
            </div>

            <!-- 聊天消息区域 -->
            <div class="flex-1 overflow-y-auto p-4" id="chatArea">
                <div class="max-w-4xl mx-auto space-y-4">
                    <!-- 欢迎消息 -->
                    <div class="text-center py-8">
                        <div class="inline-flex items-center space-x-3 bg-gray-800 rounded-full px-6 py-3">
                            <i class="fas fa-robot text-blue-400"></i>
                            <span>点击"开始"与量子加密文件销售助手对话</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 输入区域 -->
            <div class="border-t border-gray-700 p-4">
                <div class="max-w-4xl mx-auto">
                    <div class="flex space-x-3">
                        <input 
                            type="text" 
                            id="messageInput" 
                            placeholder="请输入您的问题..." 
                            class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 disabled:opacity-50"
                            disabled
                        >
                        <button 
                            id="sendButton" 
                            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let isStreaming = false;
        let currentSessionId = null;
        let currentStreamResponse = '';
        let websocket = null;
        let isReceivingResponse = false;
        
        // 演示对话内容
        const demoMessages = [
            "你好，我是某科技公司的CTO，我们对量子计算很感兴趣",
            "我们主要想解决大规模数据处理和优化问题",
            "量子计算相比传统计算有什么优势？",
            "实施量子解决方案需要多长时间？",
            "成本大概在什么范围？",
            "能给我们一个具体的应用案例吗？",
            "听起来不错，我们怎么开始合作？"
        ];

        // 初始化
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('页面加载完成，开始初始化...');
            
            // 绑定事件
            document.getElementById('sendButton').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !isStreaming) {
                    sendMessage();
                }
            });
            
            try {
                // 初始化agent服务
                await initializeAgentService();
                
                // 启用输入框和按钮
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendButton').disabled = false;
                console.log('输入框和按钮已启用');
                
                // 添加欢迎消息
                await addAIMessage('您好！我是您的量子加密文件销售小助手，请问有什么可以帮你的么？');
                
            } catch (error) {
                console.error('初始化失败:', error);
                addErrorMessage('系统初始化失败，请刷新页面重试');
            }
        });
        // 初始化agent服务
        async function initializeAgentService() {
            try {
                console.log('正在初始化agent服务...');
                
                // 检查后端是否可用
                try {
                    const healthResponse = await fetch('/api/health');
                    if (!healthResponse.ok) {
                        throw new Error('后端服务不可用');
                    }
                } catch (error) {
                    console.warn('健康检查失败，尝试直接连接agents接口:', error);
                }
                
                // 确保有可用的agent
                await ensureActiveAgent();
                
                console.log('agent服务初始化完成');
            } catch (error) {
                console.error('初始化agent服务失败:', error);
                addErrorMessage('无法连接到智能体服务，请检查后端是否正常运行');
            }
        }

        // 确保有活跃的agent
        async function ensureActiveAgent() {
            try {
                const agents = await listAgents();
                console.log('获取到的agents:', agents);
                
                if (!agents || agents.length === 0) {
                    console.log('没有找到agent，创建新agent...');
                    await createAgent(1); // 使用默认配置ID
                } else {
                    console.log('找到现有agent:', agents);
                    // 设置第一个agent为活跃agent
                    if (agents.length > 0) {
                        const firstAgent = agents[0];
                        localStorage.setItem('activeAgentId', firstAgent);
                        console.log('设置活跃agent:', firstAgent);
                    }
                }
            } catch (error) {
                console.error('确保agent存在失败:', error);
                throw error;
            }
        }

        // 列出所有agent
        async function listAgents() {
            try {
                console.log('正在获取agent列表...');
                const response = await fetch('/api/agents/list');
                console.log('agent列表响应状态:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('agent列表请求失败:', response.status, errorText);
                    throw new Error(`HTTP错误! 状态: ${response.status}, 内容: ${errorText}`);
                }
                
                const result = await response.json();
                console.log('agent列表响应数据:', result);
                
                if (result.success && result.data && result.data.agents) {
                    return result.data.agents;
                }
                return [];
            } catch (error) {
                console.error('获取agent列表失败:', error);
                return [];
            }
        }

        // 创建agent
        async function createAgent(configId) {
            try {
                const response = await fetch('/api/agents/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ agent_config_id: configId })
                });
                
                if (!response.ok) {
                    throw new Error(`创建agent失败! 状态: ${response.status}`);
                }
                
                const result = await response.json();
                if (result.success) {
                    console.log('创建agent成功:', result.data);
                    return result.data;
                } else {
                    throw new Error('创建agent失败: ' + JSON.stringify(result));
                }
            } catch (error) {
                console.error('创建agent失败:', error);
                throw error;
            }
        }

        // 获取活跃的agent_id
        async function getActiveAgentId() {
            try {
                const agents = await listAgents();
                console.log('获取到的agents列表:', agents);
                
                if (agents && agents.length > 0) {
                    // API返回的是字符串数组，直接返回第一个元素
                    const agentId = agents[0];
                    console.log('使用agent_id:', agentId);
                    return agentId;
                }
                throw new Error('没有可用的智能体');
            } catch (error) {
                console.error('获取agent_id失败:', error);
                return null;
            }
        }

        // WebSocket连接
        async function connectWebSocket() {
            return new Promise((resolve, reject) => {
                const wsUrl = window.location.protocol === 'https:' ?
                    `wss://${window.location.host}/ws/${Date.now()}` :
                    `ws://${window.location.host}/ws/${Date.now()}`;
                
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = () => {
                    console.log('WebSocket连接已建立');
                    console.log('WebSocket URL:', wsUrl);
                    resolve();
                };
                
                websocket.onmessage = (event) => {
                    console.log('收到原始WebSocket消息:', event.data);
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (error) {
                        console.error('解析WebSocket消息失败:', error, event.data);
                    }
                };
                
                websocket.onerror = (error) => {
                    console.error('WebSocket错误:', error);
                    reject(error);
                };
                
                websocket.onclose = () => {
                    console.log('WebSocket连接已关闭');
                };
            });
        }

        // 处理WebSocket消息
        function handleWebSocketMessage(data) {
            console.log('收到WebSocket消息:', data);
            switch (data.type) {
                case 'response_start':
                    isReceivingResponse = true;
                    currentStreamResponse = '';
                    break;
                    
                case 'response_chunk':
                    if (isReceivingResponse) {
                        currentStreamResponse += data.content || data.chunk || '';
                        updateAIMessage(currentStreamResponse);
                    }
                    break;
                    
                case 'response_end':
                    isReceivingResponse = false;
                    break;
                    
                case 'error':
                    console.error('服务器错误:', data.message);
                    addErrorMessage(data.message);
                    isReceivingResponse = false;
                    break;
            }
        }

        // 更新AI消息（流式显示）
        function updateAIMessage(content) {
            const chatArea = document.getElementById('chatArea');
            let aiMessageDiv = chatArea.querySelector('.ai-message:last-child');
            
            if (!aiMessageDiv || !aiMessageDiv.closest('.flex').querySelector('.fa-robot')) {
                // 创建新的AI消息容器
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex mb-4';
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center mr-2 flex-shrink-0">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="message-bubble ai-message rounded-lg p-4">
                        ${content.replace(/\n/g, '<br>')}
                    </div>
                `;
                chatArea.appendChild(messageDiv);
            } else {
                // 更新现有消息
                aiMessageDiv.innerHTML = content.replace(/\n/g, '<br>');
            }
            
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // 添加错误消息
        function addErrorMessage(message) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex mb-4 justify-center';
            messageDiv.innerHTML = `
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                    <strong>错误:</strong> ${message}
                </div>
            `;
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // 开始演示
        async function startDemo() {
            const chatArea = document.getElementById('chatArea');
            const startButton = document.querySelector('button[onclick="startDemo()"]');
            
            // 清空聊天区域
            chatArea.innerHTML = '<div class="max-w-4xl mx-auto space-y-4"></div>';
            
            // 禁用开始按钮
            startButton.disabled = true;
            startButton.textContent = '演示进行中...';
            startButton.classList.add('opacity-50');
            
            // 延迟后开始演示对话
            setTimeout(async () => {
                for (let i = 0; i < demoMessages.length; i++) {
                    // 添加用户消息
                    await addUserMessage(demoMessages[i]);
                    
                    // 等待一段时间后发送到AI
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // 调用真实API获取AI响应
                    await getRealAIResponse(demoMessages[i]);
                    
                    // 在消息之间添加延迟
                    if (i < demoMessages.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1500));
                    }
                }
                
                // 演示结束后启用用户输入
                enableUserInput();
                
            }, 2000);
        }

        // 添加用户消息
        async function addUserMessage(message) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start mb-6 justify-end';
            messageDiv.innerHTML = `
                <div class="message-bubble user-message">
                    <div class="message-content">
                        ${message.replace(/\n/g, '<br>')}
                    </div>
                </div>
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
            `;
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // 添加AI消息（支持流式输出）
        async function addAIMessage(message, isStreaming = false) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start mb-6';
            
            // 为流式消息生成唯一ID
            const messageId = isStreaming ? 'msg_' + Date.now() : null;
            
            messageDiv.innerHTML = `
                <div class="ai-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-bubble ai-message" ${messageId ? `id="${messageId}"` : ''}>
                    <div class="message-content">
                        ${message.replace(/\n/g, '<br>')}
                        ${isStreaming ? '<span class="typing-indicator">▊</span>' : ''}
                    </div>
                </div>
            `;
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
            
            return messageId;
        }

        // 追加内容到AI消息（用于流式输出）
        function appendToAIMessage(messageId, content) {
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                // 移除打字指示器
                const typingIndicator = messageElement.querySelector('.typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                
                // 追加内容
                messageElement.innerHTML += content.replace(/\n/g, '<br>');
                
                // 滚动到底部
                const chatArea = document.getElementById('chatArea');
                chatArea.scrollTop = chatArea.scrollHeight;
            }
        }

        // 标记消息完成（移除打字指示器）
        function markMessageComplete(messageId) {
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                const typingIndicator = messageElement.querySelector('.typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }
        }

        // 启用用户输入
        function enableUserInput() {
            const input = document.getElementById('messageInput');
            const button = document.getElementById('sendButton');
            const startButton = document.querySelector('button[onclick="startDemo()"]');
            
            input.disabled = false;
            button.disabled = false;
            startButton.disabled = true;
            startButton.textContent = '演示已完成';
            
            // 添加提示消息
            addAIMessage('演示对话已完成！现在您可以继续提问了。');
        }

        // 调用真实API获取AI响应
        async function getRealAIResponse(userMessage) {
            try {
                // 获取agent_id
                const agentId = await getActiveAgentId();
                if (!agentId) {
                    addErrorMessage("没有找到可用的智能体，请先创建智能体");
                    return;
                }
                
                // 使用HTTP API发送消息
                await sendMessageViaHttp(agentId, userMessage);
                
            } catch (error) {
                console.error('获取AI响应失败:', error);
                await addAIMessage('抱歉，暂时无法处理您的请求。请稍后再试。');
            }
        }

        // 发送消息到API
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || isStreaming) return;
            
            // 清空输入框
            input.value = '';
            
            // 添加用户消息
            await addUserMessage(message);
            try {
                // 获取agent_id
                const agentId = await getActiveAgentId();
                if (!agentId) {
                    addErrorMessage("没有找到可用的智能体，请先创建智能体");
                    return;
                }
                
                // 使用HTTP API发送消息
                await sendMessageViaHttp(agentId, message);
                
                // 设置接收响应的标志
                isReceivingResponse = true;
                
            } catch (error) {
                console.error('发送消息失败:', error);
                await addAIMessage('抱歉，暂时无法处理您的请求。请稍后再试。');
            }
        }

        // 等待响应完成
        function waitForResponseComplete() {
            return new Promise((resolve, reject) => {
                const maxWaitTime = 30000; // 30秒超时
                const startTime = Date.now();
                
                const checkInterval = setInterval(() => {
                    if (!isReceivingResponse) {
                        clearInterval(checkInterval);
                        resolve();
                    } else if (Date.now() - startTime > maxWaitTime) {
                        clearInterval(checkInterval);
                        reject(new Error('响应超时'));
                    }
                }, 100);
            });
        }


        // 导出对话记录
        function exportConversation() {
            const chatArea = document.getElementById('chatArea');
            const messages = chatArea.querySelectorAll('.flex.mb-4');
            
            let conversationText = '量子销售经理智能体对话记录\n\n';
            
            messages.forEach(message => {
                const isUser = message.classList.contains('justify-end');
                const bubble = message.querySelector('.message-bubble');
                if (bubble) {
                    const role = isUser ? '用户' : 'AI助手';
                    const content = bubble.textContent || bubble.innerText;
                    conversationText += `${role}: ${content}\n\n`;
                }
            });
            
            const blob = new Blob([conversationText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quantum_sales_conversation_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 处理流式响应
        async function handleStreamResponse(response) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let aiMessageContent = '';
            let aiMessageElement = null;

            try {
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    
                    // 保留最后一行（可能不完整）
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.trim() === '') continue;
                        
                        console.log('接收到行:', line);
                        
                        if (line.startsWith('data: ')) {
                            const dataStr = line.slice(6); // 移除 'data: '
                            if (dataStr === '[DONE]') {
                                console.log('流式传输完成');
                                break;
                            }
                            
                            if (dataStr.trim()) {
                                try {
                                    const eventData = JSON.parse(dataStr);
                                    console.log('流事件数据:', eventData);
                                    
                                    // 处理不同类型的事件
                                    if (eventData.type === 'stream_start') {
                                        console.log('流开始');
                                        continue;
                                    } else if (eventData.type === 'stream_end') {
                                        console.log('流结束');
                                        break;
                                    } else if (eventData.type === 'error') {
                                        console.error('服务器错误:', eventData.message);
                                        addErrorMessage(eventData.message);
                                        break;
                                    }
                                    
                                    // 处理内容块
                                    let content = '';
                                    if (eventData.content) {
                                        content = eventData.content;
                                    } else if (eventData.chunk) {
                                        content = eventData.chunk;
                                    } else if (eventData.message) {
                                        content = eventData.message;
                                    } else if (eventData.text) {
                                        content = eventData.text;
                                    } else if (typeof eventData === 'string') {
                                        content = eventData;
                                    }
                                    
                                    if (content) {
                                        // 如果是第一次收到内容，创建AI消息元素
                                        if (!aiMessageElement) {
                                            aiMessageElement = createAIMessageElement();
                                        }
                                        
                                        // 追加内容到AI消息
                                        aiMessageContent += content;
                                        aiMessageElement.innerHTML = aiMessageContent.replace(/\n/g, '<br>');
                                        scrollToBottom();
                                    }
                                } catch (parseError) {
                                    console.error('解析流数据失败:', parseError, '原始数据:', dataStr);
                                }
                            }
                        } else {
                            // 直接处理非SSE格式的响应
                            try {
                                const eventData = JSON.parse(line);
                                console.log('直接响应数据:', eventData);
                                
                                // 处理不同的响应格式
                                let content = '';
                                if (eventData.content) {
                                    content = eventData.content;
                                } else if (eventData.message) {
                                    content = eventData.message;
                                } else if (eventData.text) {
                                    content = eventData.text;
                                } else if (typeof eventData === 'string') {
                                    content = eventData;
                                }
                                
                                if (content) {
                                    // 如果是第一次收到内容，创建AI消息元素
                                    if (!aiMessageElement) {
                                        aiMessageElement = createAIMessageElement();
                                    }
                                    
                                    // 追加内容到AI消息
                                    aiMessageContent += content;
                                    aiMessageElement.innerHTML = aiMessageContent.replace(/\n/g, '<br>');
                                    scrollToBottom();
                                }
                            } catch (parseError) {
                                console.error('解析响应数据失败:', parseError, '原始数据:', line);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('读取流数据失败:', error);
            } finally {
                // 标记接收响应完成
                isReceivingResponse = false;
                console.log('流式响应处理完成');
            }
        }

        // 添加错误消息
        function addErrorMessage(message) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex mb-4';
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'w-8 h-8 rounded-full bg-red-500 flex items-center justify-center mr-3';
            avatarDiv.innerHTML = '<i class="fas fa-exclamation-triangle text-white"></i>';
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble bg-red-100 text-red-800 px-4 py-2 rounded-lg max-w-xs lg:max-w-md';
            bubbleDiv.textContent = message;
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(bubbleDiv);
            chatArea.appendChild(messageDiv);
            scrollToBottom();
        }

        // 创建AI消息元素
        function createAIMessageElement() {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex mb-4';
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center mr-3';
            avatarDiv.innerHTML = '<i class="fas fa-robot text-white"></i>';
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble bg-gray-100 text-gray-800 px-4 py-2 rounded-lg max-w-xs lg:max-w-md';
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(bubbleDiv);
            chatArea.appendChild(messageDiv);
            
            scrollToBottom();
            return bubbleDiv;
        }

        // 滚动到底部
        function scrollToBottom() {
            const chatArea = document.getElementById('chatArea');
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // 使用流式API发送消息
        async function sendMessageViaHttp(agentId, message) {
            try {
                console.log('发送消息到agent:', agentId, '消息:', message);
                
                // 如果agentId为空，先获取有效的agent_id
                if (!agentId) {
                    agentId = await getActiveAgentId();
                    if (!agentId) {
                        throw new Error('无法获取有效的agent_id');
                    }
                }
                
                const url = `/api/agents/${agentId}/stream`;
                console.log('请求URL:', url);
                
                const requestBody = {
                    message: message,
                    session_id: currentSessionId || 'default_session'
                };
                
                console.log('请求体:', JSON.stringify(requestBody));
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('响应状态:', response.status);
                console.log('响应头:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('响应错误内容:', errorText);
                    throw new Error(`HTTP错误! 状态: ${response.status}, 内容: ${errorText}`);
                }

                // 处理流式响应
                await handleStreamResponse(response);
                
            } catch (error) {
                console.error('流式API调用失败:', error);
                addErrorMessage('抱歉，暂时无法处理您的请求。请稍后再试。');
            }
        }
    </script>
</body>
</html>
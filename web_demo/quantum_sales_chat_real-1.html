<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>量子销售经理智能体 - 真实API演示</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></link>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">\n    <style>
        body {
            font-family: \'Inter\', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            margin: 0;\n            padding: 0;
            overflow-x: hidden;
            min-height: 100vh;
        }
        .chat-container {
            height: calc(100vh - 140px);
        }
        .message-bubble {
            max-width: 70%;
            min-width: 200px;
            border-radius: 18px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);\n            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            margin: 8px 0;
        }
        .message-bubble::before {
            content: \'\';
            position: absolute;
            top: 12px;\n            width: 14px;
            height: 14px;
            background: inherit;\n            clip-path: polygon(0 0, 100% 0, 0 100%);
        }
        .user-message {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 6px;
            border: 1px solid #0369a1;
            box-shadow: 0 4px 20px rgba(14, 165, 233, 0.25);
        }
        .user-message::before {\n            right: -7px;
            top: 14px;\n            transform: rotate(45deg);
            background: #0ea5e9;\n        }\n        .ai-message {\n            background: linear-gradient(135deg, #1e293b, #2d3748);
            color: #f1f5f9;
            border-bottom-left-radius: 6px;
            border: 1px solid #4a5568;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.3);
            margin-left: 0;
            margin-right: auto;
            padding: 16px 20px;
        }
        .ai-message::before {\n            left: -7px;
            top: 14px;\n            transform: rotate(-45deg);
            background: #1e293b;\n        }\n        .ai-message:hover {
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);\n            transform: translateY(-1px);
        }
        .message-content {
            padding: 16px 20px;
            line-height: 1.6;
            font-size: 14px;
            letter-spacing: 0.02em;
        }
        .ai-message .message-content {\n            font-family: \'Inter\', -apple-system, BlinkMacSystemFont, sans-serif;
            color: #e2e8f0;
            line-height: 1.8;
            font-size: 15px;
        }
        .user-message .message-content {
            font-weight: 500;
            color: white;
        }\n        .ai-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981, #059669);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            margin-right: 16px;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);\n            flex-shrink: 0;
        }
        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            margin-left: 16px;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
            flex-shrink: 0;
        }
        .flex.h-screen {
            gap: 0;
            height: 100vh;
            max-height: 100vh;
        }
        .w-80 {
            width: 280px;
            min-width: 280px;
            max-width: 280px;
        }
        @media (max-width: 1024px) {
            .w-80 {
                width: 240px;
                min-width: 240px;
                max-width: 240px;
            }
        }
        @media (max-width: 768px) {
            .flex.h-screen {
                flex-direction: column;
            }
            .w-80 {
                width: 100%;
                min-width: 100%;
                max-width: 100%;
                height: auto;
            }
            .message-bubble {
                max-width: 92%;
                min-width: 220px;
            }
            .ai-avatar, .user-avatar {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
            .message-content {
                padding: 16px 20px;
                font-size: 14px;
            }
        }
        @media (max-width: 1024px) {
            .message-bubble {
                max-width: 75%;
            }
        }
        ::-webkit-scrollbar {
            width: 8px;
        }\n        ::-webkit-scrollbar-track {
            background: #374151;\n            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #6b7280;\n            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;\n        }\n        .bg-gray-800 {\n            background-color: #1f2937 !important;
        }\n        .bg-gray-700 {\n            background-color: #374151 !important;
        }\n        .border-gray-700 {\n            border-color: #374151 !important;\n        }\n        .ai-message {\n            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);\n        }\n        .user-message {\n            box-shadow: 0 2px 12px rgba(59, 130, 246, 0.3);\n        }\n    </style>
</head>\n<body>
    <div class="flex h-screen">
        <!-- 左侧边栏 -->\n        <div class="w-80 bg-gray-800 border-r border-gray-700 flex flex-col">\n            <!-- 角色卡区域 -->
            <div class="p-4 border-b border-gray-700">
                <h2 class="text-lg font-semibold mb-3">角色选择</h2>
                <div class="space-y-2">
                    <div class="agent-card bg-gray-700 rounded-lg p-3 cursor-pointer hover:bg-gray-600 transition-colors active-agent">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center">
                                <i class="fas fa-robot text-white text-sm"></i>
                            </div>
                            <div>
                                <h3 class="font-medium">量子加密文件销售助手</h3>\n                                <p class="text-sm text-gray-300">企业级加密安全解决方案</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 工具选择区域 -->
            <div class="p-4 border-b border-gray-700">
                <h2 class="text-lg font-semibold mb-3">可用工具</h2>
                <div class="space-y-2">
                    <div class="tool-item bg-gray-700 rounded-lg p-3 cursor-not-allowed opacity-50">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-search text-blue-400"></i>
                            <span>知识库查询</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">暂未启用</p>
                    </div>
                    <div class="tool-item bg-gray-700 rounded-lg p-3 cursor-not-allowed opacity-50">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-file-alt text-green-400"></i>\n                            <span>文档分析</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">暂未启用</p>
                    </div>
                </div>
            </div>

            <!-- 底部用户区域 -->
            <div class="mt-auto p-4">
                <div class="flex items-center space-x-3">
                    <div class="relative group">
                        <div class="w-10 h-10 rounded-full bg-purple-500 flex items-center justify-center cursor-pointer" id="userAvatar">
                            <i class="fas fa-user text-white"></i>
                        </div>
                        <!-- 配置菜单 -->\n                        <div class="absolute bottom-full left-0 mb-2 w-48 bg-gray-700 rounded-lg shadow-lg hidden group-hover:block z-10" id="configMenu">
                            <div class="p-2">
                                <button class="w-full text-left px-3 py-2 rounded hover:bg-gray-600 transition-colors" onclick="exportConversation()">
                                    <i class="fas fa-download mr-2"></i>导出对话记录
                                </button>\n                            </div>
                        </div>
                    </div>
                    <div>
                        <p class="font-medium">访客用户</p>
                        <p class="text-sm text-gray-400">演示模式</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主聊天区域 -->
        <div class="flex-1 flex flex-col">\n            <!-- 顶部状态栏 -->
            <div class="bg-gray-800 border-b border-gray-700 p-4">
                <div class="flex justify-between items-center">
                    <h1 class="text-xl font-bold">量子加密文件销售助手</h1>
                    <div class="flex items-center space-x-4">
                        <div class="status-indicator flex items-center space-x-2">\n                            <div class="w-2 h-2 rounded-full bg-green-500"></div>
                            <span class="text-sm">在线</span>
                        </div>
                        <!-- 智能体管理按钮组 -->
                        <div class="flex items-center space-x-2">
                            <button class="px-3 py-1 bg-purple-600 rounded text-sm hover:bg-purple-700 transition-colors" onclick="openTemplateManager()">\n                                <i class="fas fa-cubes mr-1"></i>智能体模板管理
                            </button>\n                            <button class="px-3 py-1 bg-green-600 rounded text-sm hover:bg-green-700 transition-colors" onclick="openInstanceMenu()">
                                <i class="fas fa-play-circle mr-1"></i>智能体实例菜单
                            </button>\n                            <button class="px-3 py-1 bg-blue-600 rounded text-sm hover:bg-blue-700 transition-colors" onclick="startDemo()">
                                开始演示
                            </button>\n                        </div>
                    </div>
                </div>
            </div>

            <!-- 聊天消息区域 -->
            <div class="flex-1 overflow-y-auto p-6" id="chatArea">
                <div class="max-w-5xl mx-auto space-y-6">
                    <!-- 欢迎消息 -->\n                    <div class="text-center py-8">
                        <div class="inline-flex items-center space-x-3 bg-gray-800 rounded-full px-6 py-3">
                            <i class="fas fa-robot text-blue-400"></i>
                            <span>点击"开始"与量子加密文件销售助手对话</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 输入区域 -->\n            <div class="border-t border-gray-700 p-4">
                <div class="max-w-4xl mx-auto">\n                    <div class="flex space-x-2 items-end">
                        <textarea
                            id="messageInput"
                            placeholder="请输入您的问题..."
                            class="flex-1 bg-gray-800 border border-gray-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50 text-sm min-h-[44px] max-h-[100px] resize-y overflow-auto leading-relaxed transition-all duration-200"
                            rows="1"
                            disabled
                        >
                        <button
                            id="sendButton"
                            class="bg-blue-600 text-white px-4 py-3 rounded-xl hover:bg-blue-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed text-sm min-h-[44px] shadow-lg hover:shadow-blue-500/25"
                            disabled
                        >
                            <i class="fas fa-paper-plane"></i>
                        </button>\n                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let isStreaming = false;
        let currentSessionId = null;\n        let currentStreamResponse = \'\';
        let websocket = null;
        let isReceivingResponse = false;
        \n        // 初始化
        document.addEventListener(\'DOMContentLoaded\', async function() {
            console.log(\'页面加载完成，开始初始化...\');
            
            // 绑定事件
            document.getElementById(\'sendButton\').addEventListener(\'click\', sendMessage);
            
            // 动态调整输入框高度
            const messageInput = document.getElementById(\'messageInput\');
            messageInput.addEventListener(\'input\', function() {
                this.style.height = \'auto\';
                this.style.height = Math.min(this.scrollHeight, 120) + \'px\';
            });
            
            messageInput.addEventListener(\'keypress\', function(e) {
                if (e.key === \'Enter\' && !isStreaming) {
                    if (e.shiftKey) {
                        // Shift+Enter 换行
                        return;
                    }
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            try {
                // 初始化agent服务
                await initializeAgentService();
                
                // 启用输入框和按钮
                document.getElementById(\'messageInput\').disabled = false;
                document.getElementById(\'sendButton\').disabled = false;
                console.log(\'输入框和按钮已启用\');\n                
                // 添加欢迎消息
                await addAIMessage(\'您好！我是您的量子加密文件销售小助手，请问有什么可以帮您的么？\');\n                
            } catch (error) {
                console.error(\'初始化失败:\', error);
                addErrorMessage(\'系统初始化失败，请刷新页面重试\');\n            }
        });
        
        // 初始化agent服务
        async function initializeAgentService() {
            try {
                console.log(\'正在初始化agent服务...\');
                
                // 检查后端是否可用
                try {
                    const healthResponse = await fetch(\'/api/health\');
                    if (!healthResponse.ok) {
                        throw new Error(\'后端服务不可用\');
                    }
                } catch (error) {
                    console.warn(\'健康检查失败，尝试直接连接agents接口:\', error);\n                }
                
                // 确保有可用的agent
                await ensureActiveAgent();
                
                console.log(\'agent服务初始化完成\');
            } catch (error) {
                console.error(\'初始化agent服务失败:\', error);
                addErrorMessage(\'无法连接到智能体服务，请检查后端是否正常运行\');
            }
        }
        
        // 确保有活跃的agent
        async function ensureActiveAgent() {
            try {
                console.log(\'开始检查活跃agent...\');
                const agents = await listAgents();
                console.log(\'获取到的agents列表:\', agents);
                
                if (!agents || agents.length === 0) {
                    console.log(\'没有找到agent，创建新agent...\');
                    const newAgentResult = await createAgent(1); // 使用默认配置ID
                    console.log(\'创建agent结果:\', newAgentResult);
                    
                    // 重新获取agent列表
                    const newAgents = await listAgents();
                    console.log(\'重新获取的agents列表:\', newAgents);
                    
                    if (newAgents && newAgents.length > 0) {
                        const firstAgent = newAgents[0];\n                        localStorage.setItem(\'activeAgentId\', firstAgent);
                        console.log(\'设置新创建的agent为活跃agent:\', firstAgent);
                    }
                } else {
                    console.log(\'找到现有agent:\', agents);
                    // 设置第一个agent为活跃agent
                    if (agents.length > 0) {
                        const firstAgent = agents[0];
                        localStorage.setItem(\'activeAgentId\', firstAgent);
                        console.log(\'设置现有agent为活跃agent:\', firstAgent);
                    }
                }
                
                console.log(\'活跃agent检查完成\');
            } catch (error) {
                console.error(\'确保agent存在失败:\', error);\n                throw error;
            }
        }
        
        // 列出所有agent
        async function listAgents() {
            try {
                console.log(\'正在获取agent列表...\');
                const response = await fetch(\'/api/agents/list\');
                console.log(\'agent列表响应状态:\', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(\'agent列表请求失败:\', response.status, errorText);
                    throw new Error(`HTTP错误! 状态: ${response.status}, 内容: ${errorText}`);
                }
                
                const result = await response.json();
                console.log(\'agent列表响应数据:\', result);
                
                // 根据实际API响应结构调整
                if (result.success && result.data && result.data.agents) {\n                    // 返回agent ID列表
                    return result.data.agents;
                } else if (result.agents) {
                    // 直接返回agent ID列表
                    return result.agents;
                }
                
                console.warn(\'未找到有效的agent列表数据\');
                return [];\n            } catch (error) {
                console.error(\'获取agent列表失败:\', error);\n                return [];\n            }
        }
        
        // 创建agent
        async function createAgent(configId) {
            try {
                const response = await fetch(\'/api/agents/create\', {\n                    method: \'POST\',
                    headers: {\n                        \'Content-Type\': \'application/json\'
                    },
                    body: JSON.stringify({ agent_config_id: configId })
                });
                
                if (!response.ok) {
                    throw new Error(`创建agent失败! 状态: ${response.status}`);\n                }
                
                const result = await response.json();
                if (result.success) {\n                    console.log(\'创建agent成功:\', result.data);
                    return result.data;
                } else {
                    throw new Error(\'创建agent失败: \' + JSON.stringify(result));\n                }
            } catch (error) {
                console.error(\'创建agent失败:\', error);
                throw error;
            }
        }
        
        // 获取活跃的agent_id
        async function getActiveAgentId() {
            try {
                // 首先检查localStorage中是否有保存的agent_id
                const savedAgentId = localStorage.getItem(\'activeAgentId\');
                if (savedAgentId) {
                    console.log(\'使用保存的agent_id:\', savedAgentId);
                    return savedAgentId;
                }
                
                // 如果没有保存的agent_id，重新初始化
                console.log(\'没有保存的agent_id，重新初始化...\');
                await ensureActiveAgent();
                
                const newSavedAgentId = localStorage.getItem(\'activeAgentId\');
                if (newSavedAgentId) {\n                    console.log(\'重新初始化后获得agent_id:\', newSavedAgentId);
                    return newSavedAgentId;
                }
                
                throw new Error(\'无法获取有效的agent_id\');
            } catch (error) {
                console.error(\'获取agent_id失败:\', error);\n                return null;
            }
        }
        
        // WebSocket连接
        async function connectWebSocket() {
            return new Promise((resolve, reject) => {
                const wsUrl = window.location.protocol === \'https:\' ?
                    `wss://${window.location.host}/ws/${Date.now()}` :\n                    `ws://${window.location.host}/ws/${Date.now()}`;
                
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = () => {
                    console.log(\'WebSocket连接已建立\');
                    console.log(\'WebSocket URL:\', wsUrl);
                    resolve();
                };
                
                websocket.onmessage = (event) => {\n                    console.log(\'收到原始WebSocket消息:\', event.data);
                    
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (parseError) {
                        console.error(\'解析WebSocket消息失败:\', parseError, \'原始数据:\', event.data);
                    }
                };
                
                websocket.onerror = (error) => {
                    console.error(\'WebSocket错误:\', error);
                    reject(error);
                };
                
                websocket.onclose = () => {
                    console.log(\'WebSocket连接已关闭\');
                };
            });
        }
        
        // 处理WebSocket消息
        function handleWebSocketMessage(data) {
            console.log(\'收到WebSocket消息:\', data);
            switch (data.type) {
                case \'response_start\':
                    isReceivingResponse = true;
                    currentStreamResponse = \'\';
                    break;
                    
                case \'response_chunk\':
                    if (isReceivingResponse) {\n                        currentStreamResponse += data.content || data.chunk || \'\';
                        updateAIMessage(currentStreamResponse);\n                    }
                    break;
                    
                case \'response_end\':
                    isReceivingResponse = false;
                    break;
                    
                case \'error\':
                    console.error(\'服务器错误:\', data.message);\n                    addErrorMessage(data.message);
                    isReceivingResponse = false;
                    break;
            }
        }
        
        // 添加AI消息（流式输出）
        async function addAIMessage(message, isStreaming = false) {
            const chatArea = document.getElementById(\'chatArea\');
            const messageDiv = document.createElement(\'div\');\n            messageDiv.className = \'flex mb-4\';
            
            // 为流式消息生成唯一ID
            const messageId = isStreaming ? \'msg_\' + Date.now() : null;\n            
            messageDiv.innerHTML = `
                <div class="ai-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-bubble ai-message" ${messageId ? `id="${messageId}"` : \'\'}>\n                    <div class="message-content">
                        ${message.replace(/\
/g, \'<br>\')}
                        ${isStreaming ? \'<span class="typing-indicator">▊</span>\' : \'\'}
                    </div>
                </div>
            `;
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
            
            return messageId;
        }\n        
        // 追加内容到AI消息（用于流式输出）
        function appendToAIMessage(messageId, content) {
            const messageElement = document.getElementById(messageId);\n            if (messageElement) {\n                // 移除打字指示器
                const typingIndicator = messageElement.querySelector(\'.typing-indicator\');\n                if (typingIndicator) {\n                    typingIndicator.remove();\n                }
                
                // 追加内容
                messageElement.innerHTML += content.replace(/\
/g, \'<br>\');
                
                // 滚动到底部
                const chatArea = document.getElementById(\'chatArea\');
                chatArea.scrollTop = chatArea.scrollHeight;
            }
        }
        
        // 标记消息完成（移除打字指示器）
        function markMessageComplete(messageId) {
            const messageElement = document.getElementById(messageId);\n            if (messageElement) {\n                const typingIndicator = messageElement.querySelector(\'.typing-indicator\');\n                if (typingIndicator) {\n                    typingIndicator.remove();\n                }
            }
        }
        
        // 启用用户输入
        function enableUserInput() {
            const input = document.getElementById(\'messageInput\');
            const button = document.getElementById(\'sendButton\');
            const startButton = document.querySelector(\'button[onclick="startDemo()"]\');
            
            input.disabled = false;
            button.disabled = false;
            startButton.disabled = true;
            startButton.textContent = \'演示已完成\';
            
            // 添加提示消息
            addAIMessage(\'演示对话已完成！现在您可以继续提问了。\', false);
        }
        
        // 调用真实API获取AI响应
        async function getRealAIResponse(userMessage) {
            try {
                // 获取agent_id
                let agentId = await getActiveAgentId();
                if (!agentId) {
                    addErrorMessage("没有找到可用的智能体，请先创建智能体");
                    return;
                }
                
                console.log(\'发送消息到agent:\', agentId, \'消息:\', userMessage);
                
                // 使用HTTP API发送消息
                await sendMessageViaHttp(agentId, userMessage);
                
                // 设置接收响应的标志
                isReceivingResponse = true;
                
            } catch (error) {
                console.error(\'获取AI响应失败:\', error);\n                await addAIMessage(\'抱歉，暂时无法处理您的请求。请稍后再试。\', false);
            }
        }
        
        // 发送消息
        async function sendMessage() {
            const input = document.getElementById(\'messageInput\');
            const message = input.value.trim();
            
            if (!message || isStreaming) return;
            
            // 清空输入框
            input.value = \'\';
            
            // 添加用户消息
            await addUserMessage(message);
            try {
                // 获取agent_id - 确保有活跃的agent
                let agentId = await getActiveAgentId();
                if (!agentId) {
                    // 如果没有活跃agent，重新初始化
                    await ensureActiveAgent();
                    agentId = await getActiveAgentId();
                    if (!agentId) {
                        addErrorMessage("没有找到可用的智能体，请先创建智能体");
                        return;
                    }
                }
                
                console.log(\'发送消息到agent:\', agentId, \'消息:\', message);
                
                // 使用HTTP API发送消息
                await sendMessageViaHttp(agentId, message);
                
                // 设置接收响应的标志
                isReceivingResponse = true;
                
            } catch (error) {
                console.error(\'发送消息失败:\', error);
                await addAIMessage(\'抱歉，暂时无法处理您的请求。请稍后再试。\', false);
            }
        }
        
        // 等待响应完成
        function waitForResponseComplete() {
            return new Promise((resolve, reject) => {
                const maxWaitTime = 30000; // 30秒超时
                const startTime = Date.now();
                
                const checkInterval = setInterval(() => {
                    if (!isReceivingResponse) {\n                        clearInterval(checkInterval);
                        resolve();
                    } else if (Date.now() - startTime > maxWaitTime) {
                        clearInterval(checkInterval);
                        reject(new Error(\'响应超时\'));\n                    }
                }, 100);
            });
        }
        
        \n        // 处理流式响应
        async function handleStreamResponse(response) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();\n            let buffer = \'\';
            let aiMessageContent = \'\';
            let aiMessageElement = null;
            
            try {
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split(\'\
\');\n                    
                    // 保留最后一行（可能不完整）
                    buffer = lines.pop() || \'\';
                    
                    for (const line of lines) {
                        if (line.trim() === \'\') continue;\n                        
                        console.log(\'接收到行:\', line);
                        
                        if (line.startsWith(\'data: \')) {
                            const dataStr = line.slice(6); // 移除 \'data: \'
                            if (dataStr === \'[DONE]\') {
                                console.log(\'流式传输完成\');\n                                break;
                            }
                            
                            if (dataStr.trim()) {\n                                try {
                                    const eventData = JSON.parse(dataStr);\n                                    console.log(\'流事件数据:\', eventData);
                                    
                                    // 处理不同类型的事件
                                    if (eventData.type === \'stream_start\') {
                                        console.log(\'流开始\');
                                        continue;\n                                    } else if (eventData.type === \'stream_end\') {
                                        console.log(\'流结束\');
                                        break;
                                    } else if (eventData.type === \'error\') {
                                        console.error(\'服务器错误:\', eventData.message);\n                                        addErrorMessage(eventData.message);
                                        break;
                                    }
                                    
                                    // 处理内容块
                                    let content = \'\';
                                    if (eventData.content) {\n                                        content = eventData.content;
                                    } else if (eventData.chunk) {
                                        content = eventData.chunk;
                                    } else if (eventData.message) {
                                        content = eventData.message;
                                    } else if (eventData.text) {
                                        content = eventData.text;
                                    } else if (typeof eventData === \'string\') {
                                        content = eventData;
                                    }
                                    
                                    if (content) {
                                        // 如果是第一次收到内容，创建AI消息元素
                                        if (!aiMessageElement) {\n                                            aiMessageElement = createAIMessageElement();
                                        }
                                        
                                        // 追加内容到AI消息
                                        aiMessageContent += content;
                                        aiMessageElement.innerHTML = aiMessageContent.replace(/\\n/g, \'<br>\');
                                        scrollToBottom();
                                    }
                                } catch (parseError) {
                                    console.error(\'解析流数据失败:\', parseError, \'原始数据:\', dataStr);
                                }
                            }
                        } else {
                            // 直接处理非SSE格式的响应
                            try {
                                const eventData = JSON.parse(line);
                                console.log(\'直接响应数据:\', eventData);
                                
                                // 处理不同的响应格式
                                let content = \'\';
                                if (eventData.content) {\n                                    content = eventData.content;
                                } else if (eventData.message) {
                                    content = eventData.message;
                                } else if (eventData.text) {
                                    content = eventData.text;
                                } else if (typeof eventData === \'string\') {
                                    content = eventData;
                                }
                                
                                if (content) {
                                    // 如果是第一次收到内容，创建AI消息元素
                                    if (!aiMessageElement) {\n                                        aiMessageElement = createAIMessageElement();
                                    }
                                    
                                    // 追加内容到AI消息
                                    aiMessageContent += content;
                                    aiMessageElement.innerHTML = aiMessageContent.replace(/\\n/g, \'<br>\');
                                    scrollToBottom();
                                }
                            } catch (parseError) {
                                console.error(\'解析响应数据失败:\', parseError, \'原始数据:\', line);\n                            }
                        }
                    }
                }
            } catch (error) {
                console.error(\'读取流数据失败:\', error);\n            } finally {\n                // 标记接收响应完成
                isReceivingResponse = false;
                console.log(\'流式响应处理完成\');
            }
        }
        
        // 添加错误消息
        function addErrorMessage(message) {\n            const chatArea = document.getElementById(\'chatArea\');
            const messageDiv = document.createElement(\'div\');\n            messageDiv.className = \'flex mb-4\';
            
            const avatarDiv = document.createElement(\'div\');\n            avatarDiv.className = \'w-8 h-8 rounded-full bg-red-500 flex items-center justify-center mr-3\';
            avatarDiv.innerHTML = \'<i class="fas fa-exclamation-triangle text-white"></i>\';
            
            const bubbleDiv = document.createElement(\'div\');\n            bubbleDiv.className = \'message-bubble bg-red-100 text-red-800 px-4 py-2 rounded-lg max-w-xs lg:max-w-md\';
            bubbleDiv.textContent = message;\n            
            messageDiv.appendChild(avatarDiv);\n            messageDiv.appendChild(bubbleDiv);\n            chatArea.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // 创建AI消息元素
        function createAIMessageElement() {
            const chatArea = document.getElementById(\'chatArea\');
            const messageDiv = document.createElement(\'div\');\n            messageDiv.className = \'flex mb-4\';
            
            const avatarDiv = document.createElement(\'div\');\n            avatarDiv.className = \'w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center mr-3\';
            avatarDiv.innerHTML = \'<i class="fas fa-robot text-white"></i>\';
            
            const bubbleDiv = document.createElement(\'div\');\n            bubbleDiv.className = \'message-bubble bg-gray-100 text-gray-800 px-4 py-2 rounded-lg max-w-xs lg:max-w-md\';
            
            messageDiv.appendChild(avatarDiv);\n            messageDiv.appendChild(bubbleDiv);\n            chatArea.appendChild(messageDiv);
            
            scrollToBottom();
            return bubbleDiv;
        }
        
        // 滚动到底部
        function scrollToBottom() {\n            const chatArea = document.getElementById(\'chatArea\');
            chatArea.scrollTop = chatArea.scrollHeight;
        }\n        
        // 使用流式API发送消息
        async function sendMessageViaHttp(agentId, message) {
            try {
                console.log(\'发送消息到agent:\', agentId, \'消息:\', message);
                
                const url = `/api/agents/${agentId}/stream`;
                console.log(\'请求URL:\', url);\n                
                const requestBody = {
                    message: message,
                    session_id: currentSessionId || \'default_session\'\n                };
                
                console.log(\'请求体:\', JSON.stringify(requestBody));
                
                const response = await fetch(url, {
                    method: \'POST\',
                    headers: {\n                        \'Content-Type\': \'application/json\'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log(\'响应状态:\', response.status);
                console.log(\'响应头:\', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(\'响应错误内容:\', errorText);
                    throw new Error(`HTTP错误! 状态: ${response.status}, 内容: ${errorText}`);
                }
                
                // 处理流式响应
                await handleStreamResponse(response);\n                
            } catch (error) {
                console.error(\'流式API调用失败:\', error);\n                addAIMessage(\'抱歉，暂时无法处理您的请求。请稍后再试。\', false);
            }
        }
        
        // 导出对话记录
        function exportConversation() {
            const chatArea = document.getElementById(\'chatArea\');
            const messages = chatArea.querySelectorAll(\'.flex.mb-4\');
            
            let conversationText = \'量子销售经理智能体对话记录\
\\n\';
            
            messages.forEach(message => {
                const isUser = message.classList.contains(\'justify-end\');
                const bubble = message.querySelector(\'.message-bubble\');
                if (bubble) {
                    const role = isUser ? \'用户\' : \'AI助手\';
                    const content = bubble.textContent || bubble.innerText;
                    conversationText += `${role}: ${content}\
\
\';\n                }
            });
            
            const blob = new Blob([conversationText], { type: \'text/plain\' });
            const url = URL.createObjectURL(blob);\n            const a = document.createElement(\'a\');
            a.href = url;
            a.download = `quantum_sales_conversation_${new Date().toISOString().split(\'T\')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // 处理流式响应
        async function handleStreamResponse(response) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();\n            let buffer = \'\';
            let aiMessageContent = \'\';
            let aiMessageElement = null;
            
            try {
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split(\'\
\');\n                    
                    // 保留最后一行（可能不完整）
                    buffer = lines.pop() || \'\';
                    
                    for (const line of lines) {
                        if (line.trim() === \'\') continue;\n                        
                        console.log(\'接收到行:\', line);
                        
                        if (line.startsWith(\'data: \')) {
                            const dataStr = line.slice(6); // 移除 \'data: \'
                            if (dataStr === \'[DONE]\') {
                                console.log(\'流式传输完成\');\n                                break;
                            }
                            
                            if (dataStr.trim()) {\n                                try {
                                    const eventData = JSON.parse(dataStr);\n                                    console.log(\'流事件数据:\', eventData);
                                    
                                    // 处理不同类型的事件
                                    if (eventData.type === \'stream_start\') {
                                        console.log(\'流开始\');
                                        continue;\n                                    } else if (eventData.type === \'stream_end\') {
                                        console.log(\'流结束\');
                                        break;
                                    } else if (eventData.type === \'error\') {
                                        console.error(\'服务器错误:\', eventData.message);\n                                        addErrorMessage(eventData.message);
                                        break;
                                    }
                                    
                                    // 处理内容块
                                    let content = \'\';
                                    if (eventData.content) {\n                                        content = eventData.content;
                                    } else if (eventData.chunk) {
                                        content = eventData.chunk;
                                    } else if (eventData.message) {
                                        content = eventData.message;
                                    } else if (eventData.text) {
                                        content = eventData.text;
                                    } else if (typeof eventData === \'string\') {
                                        content = eventData;
                                    }
                                    
                                    if (content) {
                                        // 如果是第一次收到内容，创建AI消息元素
                                        if (!aiMessageElement) {\n                                            aiMessageElement = createAIMessageElement();
                                        }
                                        
                                        // 追加内容到AI消息
                                        aiMessageContent += content;
                                        aiMessageElement.innerHTML = aiMessageContent.replace(/\\n/g, \'<br>\');
                                        scrollToBottom();
                                    }
                                } catch (parseError) {
                                    console.error(\'解析流数据失败:\', parseError, \'原始数据:\', dataStr);
                                }
                            }
                        } else {
                            // 直接处理非SSE格式的响应
                            try {
                                const eventData = JSON.parse(line);
                                console.log(\'直接响应数据:\', eventData);
                                
                                // 处理不同的响应格式
                                let content = \'\';
                                if (eventData.content) {\n                                    content = eventData.content;
                                } else if (eventData.message) {
                                    content = eventData.message;
                                } else if (eventData.text) {
                                    content = eventData.text;
                                } else if (typeof eventData === \'string\') {
                                    content = eventData;
                                }
                                
                                if (content) {
                                    // 如果是第一次收到内容，创建AI消息元素
                                    if (!aiMessageElement) {\n                                        aiMessageElement = createAIMessageElement();
                                    }
                                    
                                    // 追加内容到AI消息
                                    aiMessageContent += content;
                                    aiMessageElement.innerHTML = aiMessageContent.replace(/\\n/g, \'<br>\');
                                    scrollToBottom();
                                }
                            } catch (parseError) {
                                console.error(\'解析响应数据失败:\', parseError, \'原始数据:\', line);\n                            }
                        }
                    }
                }
            } catch (error) {
                console.error(\'读取流数据失败:\', error);\n            } finally {\n                // 标记接收响应完成
                isReceivingResponse = false;
                console.log(\'流式响应处理完成\');
            }
        }
        
        // 添加错误消息
        function addErrorMessage(message) {\n            const chatArea = document.getElementById(\'chatArea\');
            const messageDiv = document.createElement(\'div\');\n            messageDiv.className = \'flex mb-4\';
            
            const avatarDiv = document.createElement(\'div\');\n            avatarDiv.className = \'w-8 h-8 rounded-full bg-red-500 flex items-center justify-center mr-3\';
            avatarDiv.innerHTML = \'<i class="fas fa-exclamation-triangle text-white"></i>\';
            
            const bubbleDiv = document.createElement(\'div\');\n            bubbleDiv.className = \'message-bubble bg-red-100 text-red-800 px-4 py-2 rounded-lg max-w-xs lg:max-w-md\';
            bubbleDiv.textContent = message;\n            
            messageDiv.appendChild(avatarDiv);\n            messageDiv.appendChild(bubbleDiv);\n            chatArea.appendChild(messageDiv);
            scrollToBottom();
        }
    </script>
</body>\n</html>
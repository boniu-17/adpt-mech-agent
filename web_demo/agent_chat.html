<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>量子销售经理智能体</title>\n    <script src="https://cdn.jsdelivr.net/npm/react@18.0.0/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.0.0/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"></link>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">\n    <style>
        body {
            font-family: \'Inter\', sans-serif;
            background-color: #f5f5f5;
        }
        .chat-container {
            height: calc(100vh - 120px);
            display: flex;
            flex-direction: column;
        }
        .message-stream {
            animation: fadeIn 0.3s ease-in-out;
        }\n        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>\n<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Agent Service API Client
        class AgentServiceClient {
            constructor() {
                this.baseURL = "http://localhost:8000";
            }

            async createAgent() {
                const response = await fetch(`${this.baseURL}/api/v1/agents/create`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        agent_config_id: 1  // 量子销售经理配置
                    })
                });
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || "创建智能体失败");
                }
                return result.data;
            }

            async sendMessage(agentId, message) {
                const response = await fetch(`${this.baseURL}/api/v1/agents/${agentId}/message`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ message })
                });
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || "发送消息失败");
                }
                return result.data;
            }

            async streamMessage(agentId, message) {
                const response = await fetch(`${this.baseURL}/api/v1/agents/${agentId}/stream`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ message })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                if (!response.body) {
                    throw new Error("No response body");
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                return {
                    async *[Symbol.asyncIterator]() {
                        try {
                            while (true) {
                                const { done, value } = await reader.read();
                                if (done) break;
                                
                                const chunk = decoder.decode(value, { stream: true });
                                const lines = chunk.split('\n');
                                
                                for (const line of lines) {
                                    if (line.startsWith('data: ')) {
                                        const dataStr = line.slice(6);
                                        if (dataStr.trim()) {
                                            try {
                                                const data = JSON.parse(dataStr);
                                                if (data.type === 'chunk' && data.content) {
                                                    yield data.content;
                                                }
                                            } catch (e) {
                                                console.warn('Failed to parse SSE data:', e);
                                            }
                                        }
                                    }
                                }
                            }
                        } finally {
                            reader.releaseLock();
                        }
                    }
                };
            }
        }

        // Main App Component
        function App() {
            const [agent, setAgent] = useState(null);
            const [messages, setMessages] = useState([]);
            const [inputMessage, setInputMessage] = useState("");
            const [isStreaming, setIsStreaming] = useState(false);
            const [streamingMessage, setStreamingMessage] = useState("");
            const messagesEndRef = useRef(null);
            const agentService = new AgentServiceClient();

            useEffect(() => {
                // Auto-scroll to bottom of messages
                if (messagesEndRef.current) {
                    messagesEndRef.current.scrollIntoView({ behavior: "smooth" });
                }
            }, [messages]);

            const handleSendMessage = async () => {
                if (!inputMessage.trim() || !agent) return;

                // Add user message
                const userMessage = {\n                    id: Date.now(),
                    text: inputMessage,
                    sender: "user",
                    timestamp: new Date()\n                };
                setMessages([...messages, userMessage]);
                setInputMessage("");

                // Start streaming agent response
                setIsStreaming(true);
                setStreamingMessage("");
                
                try {
                    const stream = await agentService.streamMessage(agent.id, inputMessage);
                    for await (const chunk of stream) {
                        setStreamingMessage(prev => prev + chunk);
                    }
                } catch (error) {
                    console.error("Error streaming message:", error);
                    setStreamingMessage("抱歉，处理您的请求时出现了问题。请稍后再试。");
                } finally {\n                    setIsStreaming(false);
                    
                    // Add agent message to messages
                    const agentMessage = {\n                        id: Date.now(),
                        text: streamingMessage,
                        sender: "agent",
                        timestamp: new Date()\n                    };
                    setMessages([...messages, userMessage, agentMessage]);
                }
            };

            const handleNewAgent = async () => {
                try {
                    setIsStreaming(true);
                    const newAgent = await agentService.createAgent();
                    setAgent(newAgent);
                    setMessages([]);
                    
                    // 自动发送欢迎消息
                    setTimeout(() => {
                        setInputMessage("你好，我是某科技公司的CTO，我们对量子计算很感兴趣");
                    }, 500);
                } catch (error) {
                    console.error("创建智能体失败:", error);
                    alert("创建智能体失败，请检查后端服务是否启动");
                } finally {
                    setIsStreaming(false);
                }
            };

            const exportConversation = () => {
                if (messages.length === 0) {
                    alert("没有对话内容可导出");
                    return;
                }
                
                const conversationText = messages.map(msg =>
                    `${msg.sender === 'user' ? '用户' : '智能体'}: ${msg.text}`
                ).join('\n');
                
                const blob = new Blob([conversationText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `quantum_sales_conversation_${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
                    {/* Header */}
                    <header className="bg-white shadow-sm border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                        <div className="flex items-center space-x-3">
                            <div className="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                                <i className="fas fa-robot text-white text-lg"></i>
                            </div>
                            <div>
                                <h1 className="text-xl font-bold text-gray-800">量子销售经理</h1>
                                <span className="text-sm text-gray-500">企业级量子计算解决方案专家</span>
                            </div>
                        </div>
                        <div className="flex items-center space-x-4">
                            <button
                                onClick={exportConversation}
                                className="flex items-center space-x-2 px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors"
                            >
                                <i className="fas fa-download"></i>
                                <span>导出对话</span>
                            </button>
                            <div className="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center cursor-pointer hover:bg-gray-300 transition-colors">
                                <i className="fas fa-user text-gray-600"></i>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <div className="flex h-[calc(100vh-80px)]">
                        {/* Left Sidebar */}
                        <div className="w-80 bg-white border-r border-gray-200 flex flex-col">
                            {/* Agent Selection */}
                            <div className="p-6 border-b border-gray-200">
                                <h2 className="text-lg font-semibold text-gray-800 mb-4">角色管理</h2>
                                <button
                                    onClick={handleNewAgent}
                                    disabled={isStreaming}
                                    className="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 px-4 rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all duration-200 flex items-center justify-center space-x-2 disabled:opacity-50"
                                >
                                    {isStreaming ? (
                                        <i className="fas fa-spinner fa-spin"></i>
                                    ) : (
                                        <i className="fas fa-plus"></i>
                                    )}
                                    <span>启动量子销售经理</span>
                                </button>
                            </div>

                            {/* Current Agent Info */}
                            {agent && (
                                <div className="p-6 border-b border-gray-200">
                                    <h3 className="text-sm font-medium text-gray-500 mb-3">当前角色</h3>
                                    <div className="bg-blue-50 rounded-lg p-4">
                                        <div className="flex items-center space-x-3 mb-2">
                                            <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                                <i className="fas fa-robot text-blue-600"></i>
                                            </div>
                                            <span className="font-medium text-blue-800">{agent.name}</span>
                                        </div>
                                        <p className="text-sm text-blue-600">{agent.description}</p>
                                    </div>
                                </div>
                            )}

                            {/* Tools Section */}
                            <div className="p-6">
                                <h3 className="text-sm font-medium text-gray-500 mb-3">功能工具</h3>
                                <div className="space-y-2">
                                    <button
                                        onClick={exportConversation}
                                        className="w-full flex items-center justify-between p-3 text-left hover:bg-gray-50 rounded-lg transition-colors group"
                                    >
                                        <div className="flex items-center space-x-3">
                                            <div className="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center group-hover:bg-green-200 transition-colors">
                                                <i className="fas fa-file-export text-green-600"></i>
                                            </div>
                                            <div>
                                                <span className="text-sm font-medium text-gray-700">导出对话记录</span>
                                                <p className="text-xs text-gray-500">保存为文本文件</p>
                                            </div>
                                        </div>
                                        <i className="fas fa-chevron-right text-gray-400 group-hover:text-gray-600"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Main Chat Area */}
                        <div className="flex-1 flex flex-col">
                            {/* Chat Messages */}
                            <div className="flex-1 overflow-y-auto p-6 space-y-6">
                                {!agent ? (
                                    <div className="h-full flex items-center justify-center">
                                        <div className="text-center">
                                            <div className="w-20 h-20 bg-gradient-to-r from-blue-100 to-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                                <i className="fas fa-robot text-3xl text-blue-500"></i>
                                            </div>
                                            <h3 className="text-xl font-semibold text-gray-700 mb-2">欢迎使用量子销售经理</h3>
                                            <p className="text-gray-500 max-w-md">点击左侧"启动量子销售经理"按钮开始对话，体验企业级量子计算解决方案的专业咨询服务。</p>
                                        </div>
                                    </div>
                                ) : messages.length === 0 ? (
                                    <div className="h-full flex items-center justify-center">
                                        <div className="text-center">
                                            <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                                <i className="fas fa-comments text-2xl text-blue-600"></i>
                                            </div>
                                            <h3 className="text-lg font-semibold text-gray-700 mb-2">开始对话</h3>
                                            <p className="text-gray-500">输入您的问题，量子销售经理将为您提供专业解答。</p>
                                        </div>
                                    </div>
                                ) : (
                                    <>
                                        {messages.map(message => (
                                            <div
                                                key={message.id}
                                                className={`flex ${message.sender === "user" ? "justify-end" : "justify-start"}`}
                                            >
                                                <div className={`max-w-2xl ${message.sender === "user" ? "bg-blue-600 text-white" : "bg-white border border-gray-200 shadow-sm"} rounded-2xl px-4 py-3`}>
                                                    <div className="flex items-center space-x-2 mb-2">
                                                        {message.sender === "agent" && (
                                                            <div className="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                                                                <i className="fas fa-robot text-blue-600 text-xs"></i>
                                                            </div>
                                                        )}
                                                        <span className="text-sm font-medium">
                                                            {message.sender === "user" ? "您" : "量子销售经理"}
                                                        </span>
                                                        {message.sender === "user" && (
                                                            <div className="w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center">
                                                                <i className="fas fa-user text-white text-xs"></i>
                                                            </div>
                                                        )}
                                                    </div>
                                                    <p className="text-sm leading-relaxed">{message.text}</p>
                                                </div>
                                            </div>
                                        ))}
                                        
                                        {/* Streaming Message */}
                                        {isStreaming && streamingMessage && (
                                            <div className="flex justify-start">
                                                <div className="max-w-2xl bg-white border border-gray-200 shadow-sm rounded-2xl px-4 py-3">
                                                    <div className="flex items-center space-x-2 mb-2">
                                                        <div className="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                                                            <i className="fas fa-robot text-blue-600 text-xs"></i>
                                                        </div>
                                                        <span className="text-sm font-medium">量子销售经理</span>
                                                        <div className="w-4 h-4 bg-blue-100 rounded-full flex items-center justify-center">
                                                            <i className="fas fa-spinner fa-spin text-blue-600 text-xs"></i>
                                                        </div>
                                                    </div>
                                                    <p className="text-sm leading-relaxed">{streamingMessage}</p>
                                                </div>
                                            </div>
                                        )}
                                    </>
                                )}
                                
                                <div ref={messagesEndRef} />
                            </div>

                            {/* Input Area */}
                            {agent && (
                                <div className="border-t border-gray-200 bg-white p-6">
                                    <div className="max-w-4xl mx-auto">
                                        <div className="flex space-x-3">
                                            <div className="flex-1 relative">
                                                <input
                                                    type="text"
                                                    value={inputMessage}
                                                    onChange={(e) => setInputMessage(e.target.value)}
                                                    onKeyPress={(e) => e.key === 'Enter' && !isStreaming && handleSendMessage()}
                                                    placeholder="请输入您的问题..."
                                                    disabled={isStreaming}
                                                    className="w-full border border-gray-300 rounded-full py-3 px-6 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50 disabled:cursor-not-allowed"
                                                />
                                                <button
                                                    onClick={handleSendMessage}
                                                    disabled={!inputMessage.trim() || isStreaming}
                                                    className="absolute right-2 top-1/2 transform -translate-y-1/2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-full w-12 h-12 flex items-center justify-center hover:from-blue-600 hover:to-purple-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                                                >
                                                    {isStreaming ? (
                                                        <i className="fas fa-spinner fa-spin"></i>
                                                    ) : (
                                                        <i className="fas fa-paper-plane"></i>
                                                    )}
                                                </button>
                                            </div>
                                        </div>
                                        <div className="mt-3 text-center">
                                            <span className="text-xs text-gray-500">按 Enter 发送消息，Shift + Enter 换行</span>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById(\'root\'));
    </script>
</body>\n</html>